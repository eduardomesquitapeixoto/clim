name: Coletor INMET

on:
  schedule:
    - cron: '0 6 * * *'
    - cron: '0 18 * * *'
  
  push:
    branches: [ "main" ]
  
  workflow_dispatch:

jobs:
  coletar:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install Chrome
      run: |
        sudo apt update
        wget -q -O chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i chrome.deb || sudo apt install -y -f
        rm chrome.deb
        sudo apt install -y xvfb libnss3 libxss1 libasound2 libxtst6
    
    - name: Install Python packages
      run: |
        pip install selenium pandas webdriver-manager
    
    - name: Run collection script
      run: |
        # Criar script Python SIMPLES
        cat > coletar.py << 'EOF'
import time
import random
import pandas as pd
import subprocess
import os
import sys
from datetime import datetime, timedelta

print("=" * 80)
print("INMET COLLECTOR")
print("=" * 80)

try:
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    from webdriver_manager.chrome import ChromeDriverManager
    from selenium.webdriver.chrome.service import Service as ChromeService
    print("âœ“ Libraries imported")
except Exception as e:
    print(f"âœ— Import error: {e}")
    sys.exit(1)

# Sample of 5 municipalities for testing
MUNICIPIOS = ['3300100', '3300159', '3300209', '3300225', '3300233']

def create_driver():
    try:
        options = Options()
        options.add_argument('--headless')
        options.add_argument('--no-sandbox')
        options.add_argument('--disable-dev-shm-usage')
        
        service = ChromeService(ChromeDriverManager().install())
        driver = webdriver.Chrome(service=service, options=options)
        driver.set_page_load_timeout(30)
        return driver
    except Exception as e:
        print(f"âœ— Driver error: {e}")
        return None

def collect_data(driver, code):
    try:
        url = f"https://previsao.inmet.gov.br/{code}"
        driver.get(url)
        time.sleep(3)
        
        # Try to find temperature data
        elements = driver.find_elements(By.CSS_SELECTOR, "div, span, p, section")
        
        data = []
        for elem in elements[:20]:
            text = elem.text.strip()
            if text and ('Â°C' in text or 'Temp' in text):
                data.append(text)
        
        if data:
            return {
                'codigo': code,
                'data': datetime.now().strftime('%Y-%m-%d'),
                'info': ' | '.join(data[:3]),
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
        else:
            return {
                'codigo': code,
                'data': datetime.now().strftime('%Y-%m-%d'),
                'info': 'No data found',
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
    except Exception as e:
        print(f"  Error: {code} - {e}")
        return None

# MAIN EXECUTION
print(f"Processing {len(MUNICIPIOS)} municipalities")
all_data = []

driver = create_driver()
if not driver:
    print("âœ— Failed to create driver")
    sys.exit(1)

for idx, municipio in enumerate(MUNICIPIOS, 1):
    print(f"[{idx}/{len(MUNICIPIOS)}] {municipio}")
    result = collect_data(driver, municipio)
    if result:
        all_data.append(result)
        print(f"  âœ“ Collected")
    time.sleep(2)

driver.quit()

# SAVE DATA
if all_data:
    df = pd.DataFrame(all_data)
    filename = 'inmet.csv'
    df.to_csv(filename, index=False, encoding='utf-8')
    
    print(f"\nâœ… SAVED: {filename}")
    print(f"ðŸ“Š Records: {len(df)}")
    print(f"\nSample data:")
    print(df.head())
    
    # Create status file
    with open('status.txt', 'w') as f:
        f.write(f"STATUS: SUCCESS\n")
        f.write(f"RECORDS: {len(df)}\n")
        f.write(f"DATE: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
else:
    print("\nâš ï¸ NO DATA COLLECTED")
    # Create empty file
    with open('inmet.csv', 'w') as f:
        f.write("codigo,data,info,timestamp\n")
    with open('status.txt', 'w') as f:
        f.write("STATUS: NO_DATA\n")

print(f"\nðŸ Finished: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print("=" * 80)
EOF

        # Set up display and run
        Xvfb :99 -screen 0 1920x1080x24 &
        export DISPLAY=:99
        
        python coletar.py
        
        echo "=== FILES CREATED ==="
        ls -la *.csv *.txt
        
        if [ -f "inmet.csv" ]; then
            echo -e "\n=== CSV CONTENT ==="
            head -5 inmet.csv
        fi
    
    - name: Commit files
      if: always()
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        
        if [ -f "inmet.csv" ]; then
            git add inmet.csv status.txt
            if ! git diff --cached --quiet; then
                git commit -m "ðŸ“Š INMET data $(date +'%Y-%m-%d %H:%M')"
                git pull --rebase
                git push
                echo "âœ… Files committed"
            fi
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: inmet-data
        path: |
          inmet.csv
          status.txt
