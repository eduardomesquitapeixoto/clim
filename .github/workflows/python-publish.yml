name: Coletor INMET GUI (92 Munic√≠pios RJ)

on:
  schedule:
    - cron: '0 6 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch:

# üîë ESSENCIAL para permitir git push
permissions:
  contents: write

jobs:
  coletar-inmet:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Instalar depend√™ncias gr√°ficas + Chrome + Chromedriver
        run: |
          sudo apt-get update

          sudo apt-get install -y \
            xvfb xauth x11-utils dbus-x11 \
            libgtk-3-0 libgbm1 libasound2 \
            libnss3 libxss1 libxtst6 \
            libatk-bridge2.0-0 libatk1.0-0 \
            libcups2 libdrm2 libxdamage1 \
            libxrandr2 fonts-liberation \
            wget unzip ca-certificates

          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -f install -y
          rm -f google-chrome-stable_current_amd64.deb

          sudo apt-get install -y chromium-chromedriver

          google-chrome --version
          chromedriver --version

      - name: Instalar depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          pip install selenium==4.16.0 pandas==2.1.3

      - name: Criar e executar coletor INMET (GUI)
        shell: bash
        run: |
          cat > coletar_inmet.py << 'EOF'
          import time, random, os
          import pandas as pd
          from datetime import datetime, timedelta

          from selenium import webdriver
          from selenium.webdriver.common.by import By
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from selenium.webdriver.chrome.service import Service
          from selenium.common.exceptions import TimeoutException, WebDriverException

          MUNICIPIOS_RJ = [
            '3300100','3300159','3300209','3300225','3300233','3300258','3300308',
            '3300407','3300456','3300506','3300605','3300704','3300803','3300902',
            '3300936','3300951','3301009','3301108','3301157','3301207','3301306',
            '3301405','3301504','3301603','3301702','3301801','3301850','3301876',
            '3301900','3302007','3302056','3302106','3302205','3302254','3302270',
            '3302304','3302403','3302452','3302502','3302601','3302700','3302809',
            '3302858','3302908','3303005','3303104','3303203','3303302','3303401',
            '3303500','3303609','3303708','3303807','3303856','3303906','3303955',
            '3304003','3304102','3304110','3304128','3304144','3304151','3304201',
            '3304300','3304409','3304508','3304524','3304557','3304607','3304706',
            '3304755','3304805','3304904','3305000','3305109','3305133','3305158',
            '3305208','3305307','3305406','3305505','3305554','3305604','3305703',
            '3305752','3305802','3305901','3306008','3306107','3306156','3306206',
            '3306305'
          ]

          MAX_TENTATIVAS = 10

          def criar_driver():
              options = Options()
              options.add_argument("--no-sandbox")
              options.add_argument("--disable-dev-shm-usage")
              options.add_argument("--window-size=1920,1080")
              service = Service("/usr/bin/chromedriver")
              driver = webdriver.Chrome(service=service, options=options)
              driver.set_page_load_timeout(90)
              return driver

          def coletar_municipio(driver, codigo):
              url = f"https://previsao.inmet.gov.br/{codigo}"
              hoje = datetime.today()
              dados = []

              driver.get(url)

              WebDriverWait(driver, 60).until(
                  EC.presence_of_element_located((By.TAG_NAME, "section"))
              )

              time.sleep(4)

              for sec in driver.find_elements(By.TAG_NAME, "section"):
                  if len(dados) >= 5:
                      break
                  txt = sec.text.lower()
                  if "m√≠nima" in txt and "m√°xima" in txt:
                      linhas = sec.text.split("\n")
                      try:
                          tmin = [l for l in linhas if "m√≠nima" in l.lower()][0]
                          tmax = [l for l in linhas if "m√°xima" in l.lower()][0]
                          dados.append({
                              "codigo_municipio": codigo,
                              "data": (hoje + timedelta(days=len(dados))).strftime("%Y-%m-%d"),
                              "temp_min": tmin.split(":")[-1].replace("¬∞c","").strip(),
                              "temp_max": tmax.split(":")[-1].replace("¬∞c","").strip(),
                              "data_coleta": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                          })
                      except:
                          pass

              if not dados:
                  raise ValueError("Sem dados extra√≠dos")

              return dados

          driver = criar_driver()
          todos = []

          for i, codigo in enumerate(MUNICIPIOS_RJ, 1):
              print(f"[{i:03d}/092] Munic√≠pio {codigo}")

              sucesso = False

              for tentativa in range(1, MAX_TENTATIVAS + 1):
                  try:
                      print(f"  Tentativa {tentativa}/10")
                      dados = coletar_municipio(driver, codigo)
                      todos.extend(dados)
                      sucesso = True
                      break

                  except (TimeoutException, WebDriverException, Exception) as e:
                      print(f"  Erro: {e}")
                      espera = 5 + tentativa * 5
                      print(f"  Aguardando {espera}s...")
                      time.sleep(espera)

                      try:
                          driver.quit()
                      except:
                          pass
                      driver = criar_driver()

              if not sucesso:
                  print(f"  ‚ùå Falhou ap√≥s 10 tentativas: {codigo}")

              time.sleep(random.uniform(3, 7))

          driver.quit()

          df = pd.DataFrame(todos)
          if df.empty:
              df = pd.DataFrame(columns=["codigo_municipio","data","temp_min","temp_max","data_coleta"])

          df.to_csv("inmet.csv", index=False)
          os.chmod("inmet.csv", 0o666)

          with open("coleta_status.txt","w") as f:
              f.write(f"STATUS: SUCESSO\nREGISTROS: {len(df)}\nDATA: {datetime.now()}\n")
          os.chmod("coleta_status.txt", 0o666)
          EOF

          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          sleep 5

          python coletar_inmet.py

      - name: Commitar resultados
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add inmet.csv coleta_status.txt

          if ! git diff --cached --quiet; then
            git commit -m "üñ•Ô∏è INMET GUI - $(date '+%Y-%m-%d %H:%M:%S')"
            git pull origin main --rebase --autostash || true
            git push origin main
          fi
