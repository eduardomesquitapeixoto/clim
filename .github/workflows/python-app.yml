name: Coletor INMET - Selenium & Chrome

on:
  schedule:
    # Executa √†s 6h e 18h UTC (3h e 15h Bras√≠lia) - duas vezes ao dia
    - cron: '0 6 * * *'
    - cron: '0 18 * * *'
  
  push:
    branches: [ "main" ]
  
  workflow_dispatch:

jobs:
  coletar-dados-inmet:
    runs-on: ubuntu-22.04
    
    timeout-minutes: 45  # Aumentado porque o script pode demorar
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configurar Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Instalar Chrome e depend√™ncias do sistema
      run: |
        echo "=== INSTALANDO DEPEND√äNCIAS DO SISTEMA ==="
        
        # Atualizar sistema
        sudo apt-get update
        
        # Instalar Chrome
        wget -q -O chrome.deb "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
        sudo apt-get install -y ./chrome.deb || true
        rm -f chrome.deb
        
        # Instalar depend√™ncias do Chrome
        sudo apt-get install -y \
          wget \
          unzip \
          xvfb \
          libnss3 \
          libxss1 \
          libasound2 \
          libxtst6 \
          libgbm1 \
          libxshmfence1 \
          libdrm2 \
          libxcb1 \
          libx11-xcb1 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgconf-2-4 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libgtk-3-0
        
        # Verificar Chrome
        echo "Vers√£o do Chrome:"
        google-chrome --version || echo "Chrome n√£o encontrado"
    
    - name: Baixar e configurar ChromeDriver
      run: |
        echo "=== CONFIGURANDO CHROMEDRIVER ==="
        
        # Obter vers√£o do Chrome
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+\.\d+' | cut -d'.' -f1)
        echo "Vers√£o principal do Chrome: $CHROME_VERSION"
        
        # Baixar ChromeDriver compat√≠vel
        CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}.0.0/linux64/chromedriver-linux64.zip"
        echo "Baixando ChromeDriver de: $CHROMEDRIVER_URL"
        
        wget -q "$CHROMEDRIVER_URL" -O chromedriver.zip
        unzip -q chromedriver.zip -d chromedriver
        
        # Mover para PATH
        sudo mv chromedriver/chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Limpar
        rm -rf chromedriver.zip chromedriver/
        
        echo "ChromeDriver instalado:"
        chromedriver --version
    
    - name: Instalar pacotes Python
      run: |
        echo "=== INSTALANDO PACOTES PYTHON ==="
        
        python -m pip install --upgrade pip
        
        # Instalar pacotes essenciais
        pip install \
          selenium==4.16.0 \
          webdriver-manager==4.0.1 \
          pandas==2.1.3 \
          numpy==1.24.3 \
          requests==2.31.0 \
          lxml==4.9.3 \
          openpyxl==3.1.2
        
        # Verificar instala√ß√£o
        python -c "import selenium; print(f'Selenium: {selenium.__version__}')"
        python -c "import pandas; print(f'Pandas: {pandas.__version__}')"
    
    - name: Criar e executar script INMET
      id: executar_script
      run: |
        echo "=== CRIANDO SCRIPT COMPLETO DO INMET ==="
        
        # Criar o script Python com TODO o seu c√≥digo
        cat > coletor_inmet.py << 'EOF'
import time
import random
import pandas as pd
import subprocess
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from datetime import datetime, timedelta
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, WebDriverException
import os
import sys

# ============================================
# CONFIGURA√á√ïES INICIAIS
# ============================================

print("=" * 80)
print("COLETOR INMET - INICIANDO NO GITHUB ACTIONS")
print(f"Data/Hora: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print("=" * 80)

# Verificar se estamos no GitHub Actions
IN_GITHUB_ACTIONS = os.getenv('GITHUB_ACTIONS') == 'true'
print(f"Executando no GitHub Actions: {IN_GITHUB_ACTIONS}")

# Configurar caminhos
WORKSPACE_DIR = os.getenv('GITHUB_WORKSPACE', os.getcwd())
print(f"Diret√≥rio de trabalho: {WORKSPACE_DIR}")

# Verificar Chrome
try:
    result = subprocess.run(['which', 'google-chrome'], capture_output=True, text=True)
    if result.returncode == 0:
        chrome_path = result.stdout.strip()
        chrome_version = subprocess.check_output([chrome_path, '--version'], stderr=subprocess.STDOUT, text=True)
        print(f"‚úì Chrome encontrado: {chrome_version.strip()}")
    else:
        # Tentar google-chrome-stable
        result = subprocess.run(['which', 'google-chrome-stable'], capture_output=True, text=True)
        if result.returncode == 0:
            chrome_path = result.stdout.strip()
            chrome_version = subprocess.check_output([chrome_path, '--version'], stderr=subprocess.STDOUT, text=True)
            print(f"‚úì Chrome encontrado: {chrome_version.strip()}")
        else:
            print("‚úó Chrome n√£o encontrado. Tentando continuar...")
except Exception as e:
    print(f"‚ö†Ô∏è  Verifica√ß√£o do Chrome: {e}")

# Configura√ß√£o do WebDriver para GitHub Actions
chrome_options = Options()

# Modo headless para CI
chrome_options.add_argument('--headless=new')
chrome_options.add_argument('--no-sandbox')
chrome_options.add_argument('--disable-dev-shm-usage')
chrome_options.add_argument('--disable-gpu')
chrome_options.add_argument('--window-size=1920,1080')

# Otimiza√ß√µes para CI
chrome_options.add_argument('--disable-extensions')
chrome_options.add_argument('--disable-software-rasterizer')
chrome_options.add_argument('--disable-background-networking')
chrome_options.add_argument('--disable-default-apps')

# Evitar detec√ß√£o como bot
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)
chrome_options.add_argument('--disable-blink-features=AutomationControlled')

# Configura√ß√µes de prefer√™ncias
prefs = {
    'profile.default_content_setting_values': {
        'images': 2,
        'javascript': 1,
    },
    'profile.managed_default_content_settings.images': 2
}
chrome_options.add_experimental_option('prefs', prefs)

# ============================================
# LISTA DE MUNIC√çPIOS (REDUZIDA PARA TESTE)
# ============================================

municipios = [
    '3300100',  # Angra dos Reis
    '3300159',  # Aperib√©
    '3300209',  # Araruama
    '3300225',  # Areal
    '3300233',  # Arma√ß√£o dos B√∫zios
    '3300258',  # Arraial do Cabo
    '3300308',  # Barra do Pira√≠
    '3300407',  # Barra Mansa
    '3300456',  # Belford Roxo
    '3300506',  # Bom Jardim
    '3300605',  # Bom Jesus do Itabapoana
    '3300704',  # Cabo Frio
    '3300803',  # Cachoeiras de Macacu
    '3300902',  # Cambuci
    '3300936',  # Carapebus
    '3300951',  # Comendador Levy Gasparian
    '3301009',  # Campos dos Goytacazes
    '3301108',  # Cantagalo
    '3301157',  # Cardoso Moreira
    '3301207'   # Carmo
]

print(f"Total de munic√≠pios a processar: {len(municipios)}")
print(f"Para teste, usando apenas os primeiros {min(10, len(municipios))} munic√≠pios")

# Usar apenas 10 para teste
municipios_teste = municipios[:10]

# ============================================
# FUN√á√ïES AUXILIARES
# ============================================

def criar_driver():
    """Cria um novo driver do Chrome"""
    try:
        print("Criando driver do Chrome...")
        
        # Configurar servi√ßo
        service = Service()
        
        # Criar driver
        driver = webdriver.Chrome(service=service, options=chrome_options)
        
        # Configurar timeouts
        driver.set_page_load_timeout(45)
        driver.implicitly_wait(15)
        
        # Executar script para evitar detec√ß√£o
        driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        
        print("‚úì Driver criado com sucesso!")
        return driver
        
    except Exception as e:
        print(f"‚úó Erro ao criar driver: {type(e).__name__}: {str(e)[:200]}")
        
        # Tentar m√©todo alternativo
        try:
            print("Tentando m√©todo alternativo...")
            from selenium.webdriver.chrome.service import Service as ChromeService
            from webdriver_manager.chrome import ChromeDriverManager
            
            service = ChromeService(ChromeDriverManager().install())
            driver = webdriver.Chrome(service=service, options=chrome_options)
            print("‚úì Driver criado com webdriver-manager!")
            return driver
        except Exception as e2:
            print(f"‚úó Falha tamb√©m com webdriver-manager: {e2}")
            raise

def processar_municipio(driver, municipio, datas):
    """Processa um munic√≠pio individual"""
    url = f"https://previsao.inmet.gov.br/{municipio}"
    
    try:
        print(f"  Acessando: {url}")
        driver.get(url)
        
        # Aguardar carregamento
        wait = WebDriverWait(driver, 30)
        wait.until(
            EC.presence_of_element_located((By.CSS_SELECTOR, "section.grid.grid-template-columns-4"))
        )
        
        time.sleep(2)  # Pausa para renderiza√ß√£o
        
        sections = driver.find_elements(By.CSS_SELECTOR, "section.grid.grid-template-columns-4")
        
        resultados = []
        
        for idx_section, section in enumerate(sections[:5]):  # Apenas 5 dias
            try:
                section_text = section.text.split("\n")
                
                temp_min = None
                temp_max = None
                
                # Buscar temperaturas
                for i in range(len(section_text)):
                    if "Temperatura M√≠nima" in section_text[i]:
                        temp_min = section_text[i + 1] if (i + 1) < len(section_text) else ''
                    if "Temperatura M√°xima" in section_text[i]:
                        temp_max = section_text[i + 1] if (i + 1) < len(section_text) else ''
                
                if temp_min and temp_max:
                    resultados.append({
                        'C√≥digo Munic√≠pio': municipio,
                        'Data': datas[idx_section].strftime('%Y-%m-%d'),
                        'Temperatura M√≠nima': temp_min.strip(),
                        'Temperatura M√°xima': temp_max.strip(),
                        'Data_Coleta': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                    })
                    
            except Exception as e:
                print(f"    Erro no dia {idx_section+1}: {e}")
                continue
        
        return resultados
        
    except TimeoutException:
        print(f"    Timeout ao carregar p√°gina")
        return []
    except Exception as e:
        print(f"    Erro: {type(e).__name__}")
        return []

# ============================================
# EXECU√á√ÉO PRINCIPAL
# ============================================

def main():
    """Fun√ß√£o principal"""
    driver = None
    
    try:
        # Criar driver
        driver = criar_driver()
        
        # Preparar datas
        hoje = datetime.today()
        datas = [hoje + timedelta(days=i) for i in range(5)]
        
        # Lista para dados
        dados = []
        
        # Processar munic√≠pios
        for idx, municipio in enumerate(municipios_teste, 1):
            print(f"\n[{idx:02d}/{len(municipios_teste):02d}] Processando munic√≠pio: {municipio}")
            
            tentativa = 1
            max_tentativas = 2
            
            while tentativa <= max_tentativas:
                try:
                    resultados = processar_municipio(driver, municipio, datas)
                    
                    if resultados:
                        dados.extend(resultados)
                        print(f"  ‚úì {len(resultados)} dias coletados")
                        break
                    else:
                        print(f"  ‚úó Nenhum dado (tentativa {tentativa}/{max_tentativas})")
                        tentativa += 1
                        
                        if tentativa <= max_tentativas:
                            time.sleep(random.uniform(2, 4))
                            
                except Exception as e:
                    print(f"  ‚úó Erro na tentativa {tentativa}: {type(e).__name__}")
                    tentativa += 1
            
            # Pequena pausa entre munic√≠pios
            if idx < len(municipios_teste):
                time.sleep(random.uniform(3, 6))
        
        # Fechar driver
        if driver:
            driver.quit()
            print("\n‚úì Driver finalizado")
        
        # Salvar resultados
        if dados:
            df = pd.DataFrame(dados)
            
            print(f"\nüìä RESULTADOS:")
            print(f"   Total de registros: {len(df)}")
            print(f"   Munic√≠pios coletados: {df['C√≥digo Munic√≠pio'].nunique()}")
            
            # Salvar CSV com timestamp
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            csv_filename = f'temperatura_inmet_{timestamp}.csv'
            
            # Garantir que estamos no diret√≥rio correto
            csv_path = os.path.join(WORKSPACE_DIR, csv_filename)
            df.to_csv(csv_path, index=False, encoding='utf-8')
            
            print(f"\nüíæ ARQUIVOS SALVOS:")
            print(f"   CSV: {csv_path}")
            
            # Verificar se o arquivo foi criado
            if os.path.exists(csv_path):
                file_size = os.path.getsize(csv_path)
                print(f"   Tamanho: {file_size:,} bytes")
                
                # Mostrar amostra
                print(f"\nüìÑ AMOSTRA (primeiras 3 linhas):")
                print(df.head(3).to_string())
                
                # Criar arquivo de status
                status_file = os.path.join(WORKSPACE_DIR, 'coleta_status.txt')
                with open(status_file, 'w') as f:
                    f.write(f"SUCESSO\n")
                    f.write(f"Registros: {len(df)}\n")
                    f.write(f"Arquivo: {csv_filename}\n")
                    f.write(f"Data: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                
                return True, csv_filename
            else:
                print("‚úó ERRO: Arquivo n√£o foi criado!")
                return False, None
        else:
            print("\n‚úó NENHUM DADO COLETADO!")
            
            # Criar arquivo de status com erro
            status_file = os.path.join(WORKSPACE_DIR, 'coleta_status.txt')
            with open(status_file, 'w') as f:
                f.write("FALHA\n")
                f.write("Nenhum dado coletado\n")
                f.write(f"Data: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            
            return False, None
            
    except Exception as e:
        print(f"\nüí• ERRO NA EXECU√á√ÉO: {type(e).__name__}")
        print(f"Detalhes: {e}")
        
        # Fechar driver se ainda aberto
        try:
            if driver:
                driver.quit()
        except:
            pass
        
        # Criar arquivo de status com erro
        try:
            status_file = os.path.join(WORKSPACE_DIR, 'coleta_status.txt')
            with open(status_file, 'w') as f:
                f.write(f"ERRO\n")
                f.write(f"{type(e).__name__}: {str(e)[:200]}\n")
                f.write(f"Data: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        except:
            pass
        
        return False, None

# ============================================
# EXECUTAR
# ============================================

if __name__ == "__main__":
    sucesso, arquivo_gerado = main()
    
    print("\n" + "=" * 80)
    if sucesso:
        print(f"‚úÖ COLETA CONCLU√çDA COM SUCESSO!")
        print(f"Arquivo gerado: {arquivo_gerado}")
    else:
        print(f"‚ùå COLETA FALHOU")
    print(f"Fim: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 80)
    
    # Sair com c√≥digo apropriado
    sys.exit(0 if sucesso else 1)
EOF

        echo "=== EXECUTANDO O SCRIPT ==="
        
        # Iniciar Xvfb para ambiente gr√°fico virtual
        Xvfb :99 -screen 0 1920x1080x24 &
        export DISPLAY=:99
        
        # Executar o script
        python coletor_inmet.py
        
        # Verificar se arquivos foram criados
        echo "=== VERIFICANDO ARQUIVOS GERADOS ==="
        ls -la *.csv *.txt 2>/dev/null || echo "Ainda n√£o h√° arquivos..."
        
        # Pequena pausa
        sleep 2
        
        # Listar novamente
        echo "Arquivos encontrados:"
        find . -name "*.csv" -o -name "*.txt" 2>/dev/null || true
    
    - name: Salvar e commitar resultados
      if: always()
      run: |
        echo "=== SALVANDO RESULTADOS ==="
        
        # Verificar arquivos CSV
        CSV_FILES=$(find . -maxdepth 1 -name "temperatura_inmet_*.csv" -type f)
        
        if [ -n "$CSV_FILES" ]; then
          echo "Arquivos CSV encontrados:"
          echo "$CSV_FILES"
          
          # Contar linhas
          for file in $CSV_FILES; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file" || echo "0")
              size=$(stat -c%s "$file" 2>/dev/null || echo "0")
              echo "  $file: $lines linhas, $size bytes"
            fi
          done
        else
          echo "‚ö†Ô∏è Nenhum arquivo CSV encontrado"
          
          # Criar arquivo vazio para evitar erros
          touch temperatura_inmet_nenhum_dado.csv
          echo "C√≥digo Munic√≠pio,Data,Temperatura M√≠nima,Temperatura M√°xima,Data_Coleta" > temperatura_inmet_nenhum_dado.csv
          echo "0000000,2024-01-01,N/A,N/A,$(date +'%Y-%m-%d %H:%M:%S')" >> temperatura_inmet_nenhum_dado.csv
        fi
        
        # Configurar git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Adicionar arquivos
        git add temperatura_inmet_*.csv coleta_status.txt 2>/dev/null || true
        
        # Verificar se h√° mudan√ßas
        if git diff --cached --quiet; then
          echo "‚úì Nenhuma mudan√ßa para commitar"
        else
          # Fazer commit
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "üìä Dados INMET coletados - $TIMESTAMP [skip ci]"
          
          # Fazer push
          echo "Fazendo push dos dados..."
          git pull origin main --rebase --autostash 2>/dev/null || true
          git push origin main
          
          echo "‚úÖ Dados commitados com sucesso!"
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dados-inmet-${{ github.run_number }}
        path: |
          temperatura_inmet_*.csv
          coleta_status.txt
        if-no-files-found: warn
        retention-days: 7
    
    - name: Limpar processos
      if: always()
      run: |
        echo "=== LIMPANDO PROCESSOS ==="
        pkill -f Xvfb 2>/dev/null || true
        pkill -f chrome 2>/dev/null || true
        echo "Processos finalizados"
